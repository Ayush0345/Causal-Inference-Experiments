# -*- coding: utf-8 -*-
"""DID_Est.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZIwXXzzggbItCPxHTSJjLJGz8Z5d8AvR
"""

import numpy as np
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf
from itertools import combinations
import plotnine as p
import matplotlib.pyplot as plt

exp = pd.read_csv('/content/experimental.csv')
nexp = pd.read_csv('/content/nonexperimental.csv')

"""(a) Descriptive Statistics - Experimental Data"""

exp75 = exp[exp['year']==75]

summary_stats = exp75.groupby('ever_treated').agg({
    'age': ['mean', 'median', 'std', 'min', 'max'],
    'educ': ['mean', 'median', 'std', 'min', 'max'],
    'marr': ['mean'],
    'nodegree': ['mean'],
    'black': ['mean'],
    'hisp': ['mean'],
    're74': ['mean', 'median', 'std', 'min', 'max'],
    'u74': ['mean']
})

# Rename the columns for better interpretation
summary_stats.columns = ['age_mean', 'age_median', 'age_std', 'age_min', 'age_max',
                         'educ_mean', 'educ_median', 'educ_std', 'educ_min', 'educ_max',
                         'marr_mean', 'nodegree_mean', 'black_mean', 'hisp_mean',
                         're74_mean', 're74_median', 're74_std', 're74_min', 're74_max',
                         'u74_mean']

print(summary_stats)

"""(b) Effect of treatment on real earning in 1978"""

# (i) Compute simple difference in means in year 1978
exp78 = exp[exp['year']==78]

treat = exp78[exp['ever_treated']==1]
control = exp78[exp['ever_treated']==0]

re_treat = treat.re
re_control = control.re

# Simple Difference in Means
sdm = re_treat.mean() - re_control.mean()
print(sdm)

# (ii) OLS using only the year 1978

re78 = exp78.re
treatment = exp78.ever_treated

model = sm.OLS(re78, treatment, data=exp).fit()
print(model.summary())

# (iii) Difference-in-Differences estimator using years 78 for post-period and 75 as the pre-period

re75 = exp75.re
re_treat75 = exp75[exp['ever_treated']==1]
re_control75 = exp75[exp['ever_treated']==0]

re_treat78 = exp78[exp['ever_treated']==1]
re_control78 = exp78[exp['ever_treated']==0]

avg_re75_treat = re_treat75.re75.mean()
avg_re75_control = re_control75.re75.mean()
avg_re78_treat = re_treat78.re.mean()
avg_re78_control = re_control78.re.mean()

did_est = (avg_re78_treat - avg_re75_treat) - (avg_re78_control - avg_re75_control)
print(did_est)

"""(c) Use non-experimental dataset (nonexperimental.csv). Repeat (b)i, (b)ii, and (b)iii."""

nexp78 = nexp[nexp['year']==78]
nexp75 = nexp[nexp['year']==75]

nre75 = nexp75.re
nre78 = nexp78.re

nre_treat75 = nexp75[nexp['ever_treated']==1]
nre_control75 = nexp75[nexp['ever_treated']==0]

nre_treat78 = nexp78[nexp['ever_treated']==1]
nre_control78 = exp78[nexp['ever_treated']==0]

avg_nre75_treat = nre_treat75.re.mean()
avg_nre75_control = nre_control75.re.mean()
avg_nre78_treat = nre_treat78.re.mean()
avg_nre78_control = nre_control78.re.mean()

did_est_nexp = (avg_nre78_treat - avg_nre75_treat) - (avg_nre78_control - avg_nre75_control)
print(did_est_nexp)

"""(d) Descriptive Statistics - Non-Experimental Data"""

nexp75 = nexp[nexp['year']==75]

nxp_summary_stats = nexp75.groupby('ever_treated').agg({
    'age': ['mean', 'median', 'std', 'min', 'max'],
    'educ': ['mean', 'median', 'std', 'min', 'max'],
    'marr': ['mean'],
    'nodegree': ['mean'],
    'black': ['mean'],
    'hisp': ['mean'],
    're74': ['mean', 'median', 'std', 'min', 'max'],
    'u74': ['mean']
})

# Rename the columns for better interpretation
nxp_summary_stats.columns = ['age_mean', 'age_median', 'age_std', 'age_min', 'age_max',
                         'educ_mean', 'educ_median', 'educ_std', 'educ_min', 'educ_max',
                         'marr_mean', 'nodegree_mean', 'black_mean', 'hisp_mean',
                         're74_mean', 're74_median', 're74_std', 're74_min', 're74_max',
                         'u74_mean']

print(nxp_summary_stats)

sm = summary_stats.mean()
nsm = nxp_summary_stats.mean()
change = sm-nsm
print(change)

"""The results from the code in cell above will compute the difference between descriptive stats in experimental and non-experimental datasets (in terms of mean of covariates).


---

(e) DID estimator in the experimental dataset controlling for the vector of covariates described in cell 3.
"""

data = pd.merge(exp75, exp78, on='id', suffixes=('75','78'))

# Creating a vector of covariates to control for in the regression model
covariates = pd.DataFrame({
    'age75': data['age75'],
    'age78' : data['age78'],
    'agesq75'  : data['agesq75'],
    'agesq78' : data['agesq78'],
    'agecube75': data['agecube75'],
    'agecube78': data['agecube78'],
    'educ75': data['educ75'],
    'educ78': data['educ78'],
    'educsq75': data['educsq75'],
    'educsq78': data['educsq78'],
    'marr75': data['marr75'],
    'marr78': data['marr78'],
    'black75': data['black75'],
    'black78': data['black78'],
    'hisp75': data['hisp75'],
    'hisp78': data['hisp78'],
    'nodegree75': data['nodegree75'],
    'nodegree78': data['nodegree78'],
    're7475': data['re7475'],
    're7478': data['re7478'],
    'u7475': data['u7475'],
    'u7478': data['u7478']
})

treatment = 'ever_treated78'
X = data[treatment]

diff = data['re78'] - data['re75']

model2 = smf.ols('diff ~ X + covariates', data=data).fit()
print(model2.summary())

"""(f) Using the DRDID command to estimate a doubly-robust difference-in-differences with covariates (Shifting to writing code in R for greater efficiency for DRDID package specifically)"""

# install.packages("remotes")
remotes::install_github("pedrohcgs/DRDID")

library(DRDID)

data <- read.csv('/content/experimental.csv')

covariates_exp <- c(
    age=data$age,
    agesq=data$agesq,
    agecube=data$agecube,
    educ=data$educ,
    educsq=data$educsq,
    marr=data$marr,
    nodegree=data$nodegree,
    black=data$black,
    hisp=data$hisp,
    re74=data$re74,
    u74=data$u74)

# DRDID estimation

model3 <- drdid(yname = "re", tname = "year", idname = "id", dname = "ever_treated",
                xformla= ~ age+agesq+agecube+educ+educsq+marr+nodegree+black+hisp+re74+u74,
            data = data, panel = TRUE)

summary(model3)

"""Using the DID estimation in part (e), we find out that the average treatment effect on the treated (ATT) is ~ 1401. In part (f), we get the doubly-robust DID estimator measuring ATT to be ~ 1549.

Comparing to part (b), ATT from DRDID is sufficiently close to the DID estimator, i.e., 1549 ~ 1529.

However, in part (c) the DID estimator in the non-experimental data is significantly different from the ATT calculated using DRDID, i.e., 13913 != 1549. (!= ~ not equal)



---


"""